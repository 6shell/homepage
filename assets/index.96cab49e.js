import{P as t,n as e,z as n,m as r,B as i}from"./index.39bf25cf.js";import"./index.053c1e4b.js";import"./color.556e4bcb.js";var o=function(){};o.prototype.append=function(t){return t.length?(t=o.from(t),!this.length&&t||t.length<200&&this.leafAppend(t)||this.length<200&&t.leafPrepend(this)||this.appendInner(t)):this},o.prototype.prepend=function(t){return t.length?o.from(t).append(this):this},o.prototype.appendInner=function(t){return new p(this,t)},o.prototype.slice=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=this.length),t>=e?o.empty:this.sliceInner(Math.max(0,t),Math.min(this.length,e))},o.prototype.get=function(t){if(!(t<0||t>=this.length))return this.getInner(t)},o.prototype.forEach=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=this.length),e<=n?this.forEachInner(t,e,n,0):this.forEachInvertedInner(t,e,n,0)},o.prototype.map=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=this.length);var r=[];return this.forEach((function(e,n){return r.push(t(e,n))}),e,n),r},o.from=function(t){return t instanceof o?t:t&&t.length?new s(t):o.empty};var s=function(t){function e(e){t.call(this),this.values=e}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(t,n){return 0==t&&n==this.length?this:new e(this.values.slice(t,n))},e.prototype.getInner=function(t){return this.values[t]},e.prototype.forEachInner=function(t,e,n,r){for(var i=e;i<n;i++)if(!1===t(this.values[i],r+i))return!1},e.prototype.forEachInvertedInner=function(t,e,n,r){for(var i=e-1;i>=n;i--)if(!1===t(this.values[i],r+i))return!1},e.prototype.leafAppend=function(t){if(this.length+t.length<=200)return new e(this.values.concat(t.flatten()))},e.prototype.leafPrepend=function(t){if(this.length+t.length<=200)return new e(t.flatten().concat(this.values))},n.length.get=function(){return this.values.length},n.depth.get=function(){return 0},Object.defineProperties(e.prototype,n),e}(o);o.empty=new s([]);var p=function(t){function e(e,n){t.call(this),this.left=e,this.right=n,this.length=e.length+n.length,this.depth=Math.max(e.depth,n.depth)+1}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(t){return t<this.left.length?this.left.get(t):this.right.get(t-this.left.length)},e.prototype.forEachInner=function(t,e,n,r){var i=this.left.length;return!(e<i&&!1===this.left.forEachInner(t,e,Math.min(n,i),r))&&(!(n>i&&!1===this.right.forEachInner(t,Math.max(e-i,0),Math.min(this.length,n)-i,r+i))&&void 0)},e.prototype.forEachInvertedInner=function(t,e,n,r){var i=this.left.length;return!(e>i&&!1===this.right.forEachInvertedInner(t,e-i,Math.max(n,i)-i,r+i))&&(!(n<i&&!1===this.left.forEachInvertedInner(t,Math.min(e,i),n,r))&&void 0)},e.prototype.sliceInner=function(t,e){if(0==t&&e==this.length)return this;var n=this.left.length;return e<=n?this.left.slice(t,e):t>=n?this.right.slice(t-n,e-n):this.left.slice(t,n).append(this.right.slice(0,e-n))},e.prototype.leafAppend=function(t){var n=this.right.leafAppend(t);if(n)return new e(this.left,n)},e.prototype.leafPrepend=function(t){var n=this.left.leafPrepend(t);if(n)return new e(n,this.right)},e.prototype.appendInner=function(t){return this.left.depth>=Math.max(this.right.depth,t.depth)+1?new e(this.left,new e(this.right,t)):new e(this,t)},e}(o),a=o,h=function(t,e){this.items=t,this.eventCount=e};h.prototype.popEvent=function(t,e){var n=this;if(0==this.eventCount)return null;for(var r,i,o=this.items.length;;o--){if(this.items.get(o-1).selection){--o;break}}e&&(r=this.remapping(o,this.items.length),i=r.maps.length);var s,p,a=t.tr,l=[],f=[];return this.items.forEach((function(t,e){if(!t.step)return r||(r=n.remapping(o,e+1),i=r.maps.length),i--,void f.push(t);if(r){f.push(new u(t.map));var c,m=t.step.map(r.slice(i));m&&a.maybeStep(m).doc&&(c=a.mapping.maps[a.mapping.maps.length-1],l.push(new u(c,null,null,l.length+f.length))),i--,c&&r.appendMap(c,i)}else a.maybeStep(t.step);return t.selection?(s=r?t.selection.map(r.slice(i)):t.selection,p=new h(n.items.slice(0,o).append(f.reverse().concat(l)),n.eventCount-1),!1):void 0}),this.items.length,0),{remaining:p,transform:a,selection:s}},h.prototype.addTransform=function(t,e,n,r){for(var i=[],o=this.eventCount,s=this.items,p=!r&&s.length?s.get(s.length-1):null,a=0;a<t.steps.length;a++){var l,c=t.steps[a].invert(t.docs[a]),m=new u(t.mapping.maps[a],c,e);(l=p&&p.merge(m))&&(m=l,a?i.pop():s=s.slice(0,s.length-1)),i.push(m),e&&(o++,e=null),r||(p=m)}var g,d,v,y=o-n.depth;return y>f&&(d=y,(g=s).forEach((function(t,e){if(t.selection&&0==d--)return v=e,!1})),s=g.slice(v),o-=y),new h(s.append(i),o)},h.prototype.remapping=function(t,e){var r=new n;return this.items.forEach((function(e,n){var i=null!=e.mirrorOffset&&n-e.mirrorOffset>=t?r.maps.length-e.mirrorOffset:null;r.appendMap(e.map,i)}),t,e),r},h.prototype.addMaps=function(t){return 0==this.eventCount?this:new h(this.items.append(t.map((function(t){return new u(t)}))),this.eventCount)},h.prototype.rebased=function(t,e){if(!this.eventCount)return this;var n=[],r=Math.max(0,this.items.length-e),i=t.mapping,o=t.steps.length,s=this.eventCount;this.items.forEach((function(t){t.selection&&s--}),r);var p=e;this.items.forEach((function(e){var r=i.getMirror(--p);if(null!=r){o=Math.min(o,r);var a=i.maps[r];if(e.step){var h=t.steps[r].invert(t.docs[r]),l=e.selection&&e.selection.map(i.slice(p+1,r));l&&s++,n.push(new u(a,h,l))}else n.push(new u(a))}}),r);for(var a=[],l=e;l<o;l++)a.push(new u(i.maps[l]));var f=this.items.slice(0,r).append(a).append(n),c=new h(f,s);return c.emptyItemCount()>500&&(c=c.compress(this.items.length-n.length)),c},h.prototype.emptyItemCount=function(){var t=0;return this.items.forEach((function(e){e.step||t++})),t},h.prototype.compress=function(t){void 0===t&&(t=this.items.length);var e=this.remapping(0,t),n=e.maps.length,r=[],i=0;return this.items.forEach((function(o,s){if(s>=t)r.push(o),o.selection&&i++;else if(o.step){var p=o.step.map(e.slice(n)),a=p&&p.getMap();if(n--,a&&e.appendMap(a,n),p){var h=o.selection&&o.selection.map(e.slice(n));h&&i++;var l,f=new u(a.invert(),p,h),c=r.length-1;(l=r.length&&r[c].merge(f))?r[c]=l:r.push(f)}}else o.map&&n--}),this.items.length,0),new h(a.from(r.reverse()),i)},h.empty=new h(a.empty,0);var u=function(t,e,n,r){this.map=t,this.step=e,this.selection=n,this.mirrorOffset=r};u.prototype.merge=function(t){if(this.step&&t.step&&!t.selection){var e=t.step.merge(this.step);if(e)return new u(e.getMap().invert(),e,this.selection)}};var l=function(t,e,n,r){this.done=t,this.undone=e,this.prevRanges=n,this.prevTime=r},f=20;function c(t){var e=[];return t.forEach((function(t,n,r,i){return e.push(r,i)})),e}function m(t,e){if(!t)return null;for(var n=[],r=0;r<t.length;r+=2){var i=e.map(t[r],1),o=e.map(t[r+1],-1);i<=o&&n.push(i,o)}return n}function g(t,e,n,r){var i=y(e),o=w.get(e).spec.config,s=(r?t.undone:t.done).popEvent(e,i);if(s){var p=s.selection.resolve(s.transform.doc),a=(r?t.done:t.undone).addTransform(s.transform,e.selection.getBookmark(),o,i),h=new l(r?a:s.remaining,r?s.remaining:a,null,0);n(s.transform.setSelection(p).setMeta(w,{redo:r,historyState:h}).scrollIntoView())}}var d=!1,v=null;function y(t){var e=t.plugins;if(v!=e){d=!1,v=e;for(var n=0;n<e.length;n++)if(e[n].spec.historyPreserveItems){d=!0;break}}return d}var w=new t("history"),M=new t("closeHistory");function I(t){return t={depth:t&&t.depth||100,newGroupDelay:t&&t.newGroupDelay||500},new e({key:w,state:{init:function(){return new l(h.empty,h.empty,null,0)},apply:function(e,n,r){return function(t,e,n,r){var i,o=n.getMeta(w);if(o)return o.historyState;n.getMeta(M)&&(t=new l(t.done,t.undone,null,0));var s=n.getMeta("appendedTransaction");if(0==n.steps.length)return t;if(s&&s.getMeta(w))return s.getMeta(w).redo?new l(t.done.addTransform(n,null,r,y(e)),t.undone,c(n.mapping.maps[n.steps.length-1]),t.prevTime):new l(t.done,t.undone.addTransform(n,null,r,y(e)),null,t.prevTime);if(!1===n.getMeta("addToHistory")||s&&!1===s.getMeta("addToHistory"))return(i=n.getMeta("rebased"))?new l(t.done.rebased(n,i),t.undone.rebased(n,i),m(t.prevRanges,n.mapping),t.prevTime):new l(t.done.addMaps(n.mapping.maps),t.undone.addMaps(n.mapping.maps),m(t.prevRanges,n.mapping),t.prevTime);var p=0==t.prevTime||!s&&(t.prevTime<(n.time||0)-r.newGroupDelay||!function(t,e){if(!e)return!1;if(!t.docChanged)return!0;var n=!1;return t.mapping.maps[0].forEach((function(t,r){for(var i=0;i<e.length;i+=2)t<=e[i+1]&&r>=e[i]&&(n=!0)})),n}(n,t.prevRanges)),a=s?m(t.prevRanges,n.mapping):c(n.mapping.maps[n.steps.length-1]);return new l(t.done.addTransform(n,p?e.selection.getBookmark():null,r,y(e)),h.empty,a,n.time)}(n,r,e,t)}},config:t,props:{handleDOMEvents:{beforeinput:function(t,e){var n="historyUndo"==e.inputType?E(t.state,t.dispatch):"historyRedo"==e.inputType&&b(t.state,t.dispatch);return n&&e.preventDefault(),n}}}})}function E(t,e){var n=w.getState(t);return!(!n||0==n.done.eventCount)&&(e&&g(n,t,e,!1),!0)}function b(t,e){var n=w.getState(t);return!(!n||0==n.undone.eventCount)&&(e&&g(n,t,e,!0),!0)}const T=r((()=>({prosePlugins:()=>[I(),i({"Mod-z":E,"Mod-y":b,"Shift-Mod-z":b})]})))();export{T as history};
